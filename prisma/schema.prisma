generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email         String     @unique
  name          String?
  image         String?
  password_hash String?
  createdAt     DateTime?  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLoginAt   DateTime?  @map("last_login_at") @db.Timestamptz(6)
  sessions      sessions[]

  @@map("users")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model conversations {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title      String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  runs       runs[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model flows {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  prompts     prompts[]
  runs        runs[]

  @@index([created_at(sort: Desc)], map: "idx_flows_created_at")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model outputs {
  id           String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  response_id  String?    @db.Uuid
  provider_id  String?
  text         String?
  content_type String?
  annotations  String?
  created_at   DateTime?  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime?  @default(now()) @db.Timestamptz(6)
  responses    responses? @relation(fields: [response_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([response_id], map: "idx_outputs_response_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model prompt_runs {
  id                     String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  prompt_id              String?     @db.Uuid
  run_id                 String?     @db.Uuid
  status                 String?     @default("pending")
  response               Json?
  input_tokens           Int?
  output_tokens          Int?
  total_tokens           Int?
  selected_provider      String?
  model                  String?
  source_attachment_urls Json?       @default("[]")
  attachment_urls        Json?       @default("[]")
  started_at             DateTime?   @db.Timestamptz(6)
  completed_at           DateTime?   @db.Timestamptz(6)
  created_at             DateTime?   @default(now()) @db.Timestamptz(6)
  updated_at             DateTime?   @default(now()) @db.Timestamptz(6)
  prompts                prompts?    @relation(fields: [prompt_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  runs                   runs?       @relation(fields: [run_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  responses              responses[]

  @@index([prompt_id], map: "idx_prompt_runs_prompt_id")
  @@index([run_id], map: "idx_prompt_runs_run_id")
  @@index([status], map: "idx_prompt_runs_status")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model prompts {
  id                        String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  flow_id                   String?       @db.Uuid
  type                      String?       @default("Prompt")
  action                    String?
  endpoint_type             String        @default("Chat")
  selected_provider         String        @default("OpenAI")
  selected_model            String        @default("gpt-4o")
  system_prompt             String?
  tools                     Json?         @default("[]")
  background_prompt         String?
  foreground_prompt         String?
  negative_prompt           String?
  preserve_original_subject Float?
  original_background_depth Float?
  keep_original_background  Boolean?      @default(false)
  light_source_direction    String?
  light_source_strength     Float?
  seed                      Float?
  output_format             String?
  size                      String?
  quality                   String?
  subject_image_url         String?
  background_reference_url  String?
  attachment_urls           Json?         @default("[]")
  position                  Int?          @default(0)
  created_at                DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at                DateTime?     @default(now()) @db.Timestamptz(6)
  prompt_runs               prompt_runs[]
  flows                     flows?        @relation(fields: [flow_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([flow_id], map: "idx_prompts_flow_id")
  @@index([flow_id, position], map: "idx_prompts_position")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model responses {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  prompt_run_id String?      @db.Uuid
  provider_id   String?
  role          String?
  response_type String?
  status        String?
  call_id       String?
  name          String?
  arguments     String?
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?    @default(now()) @db.Timestamptz(6)
  outputs       outputs[]
  prompt_runs   prompt_runs? @relation(fields: [prompt_run_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([prompt_run_id], map: "idx_responses_prompt_run_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model run_webhooks {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  run_id            String?   @db.Uuid
  event_type        String
  payload           Json
  status            String?   @default("pending")
  attempt_count     Int?      @default(0)
  last_attempted_at DateTime? @db.Timestamptz(6)
  error_message     String?
  endpoint_url      String
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)
  runs              runs?     @relation(fields: [run_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([run_id], map: "idx_run_webhooks_run_id")
  @@index([status], map: "idx_run_webhooks_status")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model runs {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  flow_id         String?        @db.Uuid
  conversation_id String?        @db.Uuid
  status          String?        @default("pending")
  message         String?
  input_image_url String?
  webhook_url     String?
  variables       Json?          @default("{}")
  attachment_urls Json?          @default("[]")
  data            Json?          @default("{}")
  started_at      DateTime?      @db.Timestamptz(6)
  completed_at    DateTime?      @db.Timestamptz(6)
  created_at      DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?      @default(now()) @db.Timestamptz(6)
  source_run_id   String?        @db.Uuid
  prompt_runs     prompt_runs[]
  run_webhooks    run_webhooks[]
  conversations   conversations? @relation(fields: [conversation_id], references: [id], onUpdate: NoAction)
  flows           flows?         @relation(fields: [flow_id], references: [id], onUpdate: NoAction)
  runs            runs?          @relation("runsToruns", fields: [source_run_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_runs      runs[]         @relation("runsToruns")

  @@index([conversation_id], map: "idx_runs_conversation_id")
  @@index([created_at(sort: Desc)], map: "idx_runs_created_at")
  @@index([flow_id], map: "idx_runs_flow_id")
  @@index([source_run_id], map: "idx_runs_source_run_id")
  @@index([status], map: "idx_runs_status")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model sessions {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String?   @db.Uuid
  ip_address String?
  user_agent String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  users      User?     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_sessions_user_id")
}
